<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Comparison</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .comparison-row {
        margin-bottom: 30px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .image-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 1000px;
        width: 100%;
      }
      .image-container img {
        max-width: 100%;
        max-height: 1000px;
        object-fit: contain;
      }
      .checkbox-container {
        display: flex;
        flex-direction: column;
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
      }
      .form-check {
        margin-right: 15px;
        display: inline-block;
      }
      .navigation-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
      }
      .image-label {
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .product-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .separator {
        height: 1px;
        background-color: #dee2e6;
        margin: 20px 0;
      }

      .image-row {
        display: flex;
        align-items: start;
      }

      .container-main {
        width: 100%;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container-main">
      <div class="product-header">
        <h1 class="mb-0">Image Comparison</h1>
        <h3 id="product-id">Product ID: Loading...</h3>
      </div>

      <form id="comparison-form">
        <div id="image-comparison-container">
          <!-- Images and checkboxes will be loaded here -->
        </div>

        <div class="navigation-buttons">
          <button type="button" id="back-button" class="btn btn-secondary">
            Previous Product
          </button>
          <button type="button" id="submit-button" class="btn btn-success">
            Submit Evaluation
          </button>
          <button type="button" id="next-button" class="btn btn-primary">
            Next Product
          </button>
        </div>
      </form>
    </div>

    <script>
      // Current product data
      let currentProduct = null;

      // Fetch data from API
      async function fetchProductData(productIndex = 0) {
        try {
          // Replace with your actual API endpoint
          const response = await fetch(`/api/products/firstpass-filter`);
          currentProduct = await response.json();
          renderProductImages();
          document.getElementById(
            "product-id"
          ).textContent = `Product ID: ${currentProduct.product_id}`;
        } catch (error) {
          console.error("Error fetching product data:", error);
          document.getElementById("image-comparison-container").innerHTML =
            '<div class="alert alert-danger">Error loading images. Please try again later.</div>';
        }
      }

      // Render all images for the current product
      function renderProductImages() {
        if (
          !currentProduct ||
          !currentProduct.new_images ||
          currentProduct.new_images.length === 0
        ) {
          return;
        }

        const container = document.getElementById("image-comparison-container");
        container.innerHTML = "";

        // For each new image, create a row with original + new image
        currentProduct.new_images.forEach((newImage, index) => {
          const rowElement = document.createElement("div");
          rowElement.className = "comparison-row";
          rowElement.innerHTML = `
                    <div class="image-label">Comparison ${index + 1}: ${
            newImage.name
          }</div>
                    <div class="image-row">
                        <div class="col">
                            <div class="image-container">
                                <img src="${
                                  currentProduct.orignal_image_path
                                }" alt="Original Image" class="img-fluid">
                            </div>
                            <div class="text-center"><strong>Original Image</strong></div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="image-container">
                                <img src="${newImage.path}" alt="${
            newImage.name
          }" class="img-fluid">
                            </div>
                            <div class="text-center"><strong>${
                              newImage.name
                            }</strong></div>

                        </div>
        <div class="checkbox-container">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cloth-good-${index}" name="cloth-good-${index}">
                            <label class="form-check-label" for="cloth-good-${index}">Cloth Good</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hair-good-${index}" name="hair-good-${index}">
                            <label class="form-check-label" for="hair-good-${index}">Hair Good</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hand-good-${index}" name="hand-good-${index}">
                            <label class="form-check-label" for="hand-good-${index}">Hand Good</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="face-good-${index}" name="face-good-${index}">
                            <label class="form-check-label" for="face-good-${index}">Face Good</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="upscale-good-${index}" name="upscale-good-${index}">
                            <label class="form-check-label" for="upscale-good-${index}">Upscale Good</label>
                        </div>
                    </div>

                    </div>
            
                `;
          container.appendChild(rowElement);

          // If it's not the last item, add a separator
          if (index < currentProduct.new_images.length - 1) {
            const separator = document.createElement("div");
            separator.className = "separator";
            container.appendChild(separator);
          }
        });

        // Restore any previously saved checkbox states
        restoreCheckboxStates();
      }

      // Get the evaluation data from checkboxes
      function collectEvaluationData() {
        if (!currentProduct || !currentProduct.new_images) return null;

        const evaluations = [];

        currentProduct.new_images.forEach((newImage, index) => {
          evaluations.push({
            imageName: newImage.name,
            evaluations: {
              clothGood: document.getElementById(`cloth-good-${index}`).checked,
              hairGood: document.getElementById(`hair-good-${index}`).checked,
              handGood: document.getElementById(`hand-good-${index}`).checked,
              faceGood: document.getElementById(`face-good-${index}`).checked,
              upscaleGood: document.getElementById(`upscale-good-${index}`)
                .checked,
            },
          });
        });

        return {
          productId: currentProduct.product_id,
          evaluations: evaluations,
        };
      }

      // Save checkbox states back to current product object
      function saveCheckboxStates() {
        if (!currentProduct || !currentProduct.new_images) return;

        currentProduct.new_images.forEach((newImage, index) => {
          if (!newImage.evaluations) {
            newImage.evaluations = {};
          }

          newImage.evaluations.clothGood = document.getElementById(
            `cloth-good-${index}`
          ).checked;
          newImage.evaluations.hairGood = document.getElementById(
            `hair-good-${index}`
          ).checked;
          newImage.evaluations.handGood = document.getElementById(
            `hand-good-${index}`
          ).checked;
          newImage.evaluations.faceGood = document.getElementById(
            `face-good-${index}`
          ).checked;
          newImage.evaluations.upscaleGood = document.getElementById(
            `upscale-good-${index}`
          ).checked;
        });
      }

      // Restore checkbox states from current product object
      function restoreCheckboxStates() {
        if (!currentProduct || !currentProduct.new_images) return;

        currentProduct.new_images.forEach((newImage, index) => {
          if (newImage.evaluations) {
            document.getElementById(`cloth-good-${index}`).checked =
              newImage.evaluations.clothGood || false;
            document.getElementById(`hair-good-${index}`).checked =
              newImage.evaluations.hairGood || false;
            document.getElementById(`hand-good-${index}`).checked =
              newImage.evaluations.handGood || false;
            document.getElementById(`face-good-${index}`).checked =
              newImage.evaluations.faceGood || false;
            document.getElementById(`upscale-good-${index}`).checked =
              newImage.evaluations.upscaleGood || false;
          }
        });
      }

      // Handle form submission
      function handleSubmit() {
        const evaluationData = collectEvaluationData();
        if (!evaluationData) return;

        // Send data to server (replace with your actual endpoint)
        fetch("/api/submit-evaluations", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(evaluationData),
        })
          .then((response) => response.json())
          .then((data) => {
            alert("Evaluation submitted successfully!");
            // Optionally redirect to next product or reset
          })
          .catch((error) => {
            console.error("Error submitting evaluation:", error);
            alert("Error submitting evaluation. Please try again.");
          });
      }

      // Current product index for navigation
      let currentProductIndex = 0;

      // Navigation event handlers
      document.getElementById("next-button").addEventListener("click", () => {
        saveCheckboxStates();
        currentProductIndex++;
        fetchProductData(currentProductIndex);
      });

      document.getElementById("back-button").addEventListener("click", () => {
        saveCheckboxStates();
        if (currentProductIndex > 0) {
          currentProductIndex--;
          fetchProductData(currentProductIndex);
        }
      });

      document
        .getElementById("submit-button")
        .addEventListener("click", handleSubmit);

      // Initialize the page
      document.addEventListener("DOMContentLoaded", () => {
        fetchProductData(currentProductIndex);
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
